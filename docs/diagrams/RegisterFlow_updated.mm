<map version="0.7.1"><node ID="1" TEXT="CapeControl&#x20;Registration&#x20;Flow&#x20;&amp;&#x20;Database&#x20;Interaction"><node ID="2" TEXT="1)&#x20;Entry&#x20;Point"><node ID="3" TEXT="Landing&#x20;Page"><node ID="4" TEXT="User&#x20;clicks&#x20;Create&#x20;free&#x20;account&#x20;(global&#x20;CTA)" ></node><node ID="5" TEXT="Route&#x20;to&#x20;/auth/register" /><node ID="6" TEXT="Preserve&#x20;context&#x20;(optional)"><node ID="7" TEXT="ref/utm/interest&#x20;trail&#x20;stored&#x20;safely" /></node></node></node><node ID="8" TEXT="2)&#x20;Register&#x20;Form&#x20;(Frontend)"><node ID="9" TEXT="User&#x20;inputs"><node ID="10" TEXT="Name&#x20;(optional/required&#x20;per&#x20;spec)" /><node ID="11" TEXT="Email" ></node><node ID="12" TEXT="Password" ></node><node ID="13" TEXT="Confirm&#x20;password" ></node><node ID="14" TEXT="Accept&#x20;Terms/Privacy&#x20;checkbox&#x20;(optional:&#x20;gate&#x20;at&#x20;/terms)" /></node><node ID="15" TEXT="Client-side&#x20;validation"><node ID="16" TEXT="Email&#x20;format" ></node><node ID="17" TEXT="Password&#x20;rules&#x20;(length/complexity)" /><node ID="18" TEXT="Password&#x20;match" ></node><node ID="19" TEXT="Terms&#x20;checkbox&#x20;required?" ></node></node><node ID="20" TEXT="If&#x20;validation&#x20;fails"><node ID="21" TEXT="Show&#x20;inline&#x20;errors" ></node><node ID="22" TEXT="Do&#x20;not&#x20;submit" ></node></node><node ID="23" TEXT="Submit&#x20;UX"><node ID="24" TEXT="Disable&#x20;button&#x20;+&#x20;show&#x20;loading" ></node><node ID="25" TEXT="Prevent&#x20;double-submit" ></node></node></node><node ID="26" TEXT="3)&#x20;API&#x20;Call&#x20;to&#x20;Backend"><node ID="27" TEXT="Request"><node ID="28" TEXT="POST&#x20;/api/auth/register&#x20;(example)" /><node ID="29" TEXT="Payload"><node ID="30" TEXT="name,email,password,(confirm_password&#x20;for&#x20;validation&#x20;only),termsAccepted(optional)" ></node></node></node><node ID="31" TEXT="Response&#x20;handling"><node ID="32" TEXT="Success&#x20;-&#x20;advance&#x20;flow" ></node><node ID="33" TEXT="Failure&#x20;-&#x20;friendly&#x20;message" ></node></node></node><node ID="34" TEXT="4)&#x20;Backend&#x20;Registration&#x20;Logic"><node ID="35" TEXT="Input&#x20;processing"><node ID="36" TEXT="Trim&#x20;fields" ></node><node ID="37" TEXT="Normalize&#x20;email&#x20;(lowercase)" ></node><node ID="38" TEXT="Validate&#x20;schema&#x20;(required&#x20;fields,&#x20;password&#x20;policy)" ></node><node ID="118" TEXT="confirm_password&#x20;used&#x20;only&#x20;to&#x20;validate&#x20;match;&#x20;discard" ></node></node><node ID="39" TEXT="Security"><node ID="40" TEXT="Rate-limit&#x20;registration&#x20;attempts" ></node><node ID="41" TEXT="Audit&#x20;log&#x20;(optional)" ></node><node ID="42" TEXT="Never&#x20;store&#x20;plain&#x20;password" ></node></node><node ID="43" TEXT="Database&#x20;interaction"><node ID="115" TEXT="BEGIN&#x20;transaction&#x20;(users&#x20;+&#x20;related&#x20;rows)" ></node><node ID="44" TEXT="Enforce&#x20;unique&#x20;email&#x20;(race-safe)"><node ID="45" TEXT="DB&#x20;UNIQUE&#x20;constraint:&#x20;CITEXT&#x20;email&#x20;or&#x20;UNIQUE(lower(email))" ></node><node ID="112" TEXT="Optional&#x20;fast-path:&#x20;SELECT&#x20;by&#x20;email&#x20;for&#x20;friendly&#x20;message&#x20;(not&#x20;authoritative)" ></node><node ID="113" TEXT="Still&#x20;rely&#x20;on&#x20;UNIQUE&#x20;constraint&#x20;as&#x20;final&#x20;authority" ></node></node><node ID="46" TEXT="Hash&#x20;password"><node ID="47" TEXT="bcrypt/argon2&#x20;hash" /></node><node ID="48" TEXT="Insert&#x20;user"><node ID="49" TEXT="INSERT&#x20;into&#x20;users&#x20;(...)&#x20;RETURNING&#x20;id&#x20;(handle&#x20;unique_violation&#x20;-&gt;&#x20;409)" ></node><node ID="114" TEXT="On&#x20;unique_violation:&#x20;return&#x20;409&#x20;(avoid&#x20;user&#x20;enumeration)" ></node></node><node ID="50" TEXT="Create&#x20;related&#x20;rows&#x20;(optional)"><node ID="51" TEXT="profile&#x20;row" ></node><node ID="52" TEXT="onboarding_state&#x20;row" ></node><node ID="53" TEXT="terms_acceptance&#x20;state&#x20;fields" ></node></node><node ID="116" TEXT="COMMIT&#x20;transaction&#x20;(ROLLBACK&#x20;on&#x20;any&#x20;error)"><node ID="117" TEXT="Rollback&#x20;prevents&#x20;partial&#x20;user/profile/onboarding&#x20;rows" /></node></node><node ID="54" TEXT="Outcomes"><node ID="55" TEXT="201&#x20;Created"><node ID="56" TEXT="Return&#x20;user&#x20;id&#x20;+&#x20;session/token&#x20;(if&#x20;auto-login)" /></node><node ID="57" TEXT="409&#x20;Conflict"><node ID="58" TEXT="Email&#x20;already&#x20;exists" ></node></node><node ID="59" TEXT="400&#x20;Bad&#x20;Request"><node ID="60" TEXT="Validation&#x20;error&#x20;details" ></node></node><node ID="61" TEXT="429&#x20;Too&#x20;Many&#x20;Requests"><node ID="62" TEXT="Rate-limited" ></node></node><node ID="63" TEXT="500&#x20;Server&#x20;Error"><node ID="64" TEXT="Generic&#x20;message&#x20;to&#x20;user" ></node></node></node></node><node ID="65" TEXT="5)&#x20;Auth&#x20;Session&#x20;Creation"><node ID="66" TEXT="Option&#x20;A:&#x20;Auto-login"><node ID="67" TEXT="Issue&#x20;JWT/session" /><node ID="68" TEXT="Store&#x20;securely"><node ID="69" TEXT="Prefer&#x20;httpOnly&#x20;cookie" ></node></node></node><node ID="70" TEXT="Option&#x20;B:&#x20;Email&#x20;verification"><node ID="71" TEXT="Create&#x20;unverified&#x20;account"><node ID="119" TEXT="Generate&#x20;verification&#x20;token&#x20;(random,&#x20;one-time)" ></node><node ID="120" TEXT="Store&#x20;hashed&#x20;token&#x20;+&#x20;expiry&#x20;in&#x20;DB&#x20;(verification_tokens)" ></node><node ID="121" TEXT="Send&#x20;email&#x20;only&#x20;after&#x20;successful&#x20;commit" ></node></node><node ID="72" TEXT="Send&#x20;verification&#x20;email" ></node><node ID="73" TEXT="Block&#x20;login&#x20;until&#x20;verified&#x20;(optional)" ></node></node></node><node ID="74" TEXT="6)&#x20;Post-Register&#x20;Routing"><node ID="75" TEXT="Recommended&#x20;MVP&#x20;path"><node ID="76" TEXT="/onboarding/welcome" /><node ID="77" TEXT="/onboarding/profile" /><node ID="78" TEXT="/onboarding/checklist" /><node ID="79" TEXT="/app/dashboard" /></node><node ID="80" TEXT="Preserve&#x20;context"><node ID="81" TEXT="Show&#x20;personalized&#x20;next-step&#x20;based&#x20;on&#x20;ref/interest" /></node></node><node ID="82" TEXT="7)&#x20;Terms&#x20;Gate&#x20;(if&#x20;enforced)"><node ID="83" TEXT="Data&#x20;fields"><node ID="84" TEXT="terms_accepted_at&#x20;timestamp&#x20;(or&#x20;equivalent)" ></node><node ID="122" TEXT="terms_version&#x20;(string)" ></node></node><node ID="85" TEXT="Frontend&#x20;guard"><node ID="86" TEXT="If&#x20;missing,&#x20;force&#x20;route&#x20;to&#x20;/terms" /><node ID="87" TEXT="Block&#x20;/app/*&#x20;until&#x20;accepted" /></node><node ID="88" TEXT="Backend&#x20;enforcement"><node ID="89" TEXT="Protected&#x20;endpoints&#x20;verify&#x20;terms&#x20;state" ></node></node><node ID="90" TEXT="Acceptance"><node ID="91" TEXT="User&#x20;accepts&#x20;terms" ></node><node ID="92" TEXT="Update&#x20;DB"><node ID="93" TEXT="UPDATE&#x20;users&#x20;SET&#x20;terms_accepted_at=now(),&#x20;terms_version=:current" ></node></node><node ID="94" TEXT="Allow&#x20;app&#x20;access" ></node></node></node><node ID="95" TEXT="8)&#x20;Verification&#x20;Checklist&#x20;(Evidence)"><node ID="96" TEXT="Frontend"><node ID="97" TEXT="Routes:&#x20;landing&#x20;→&#x20;register&#x20;→&#x20;next" ></node><node ID="98" TEXT="Validation&#x20;errors&#x20;render&#x20;correctly" ></node><node ID="99" TEXT="Loading&#x20;state&#x20;works" ></node><node ID="100" TEXT="409/400/429&#x20;messages&#x20;mapped&#x20;cleanly" /><node ID="101" TEXT="Auth&#x20;stored&#x20;securely" ></node></node><node ID="102" TEXT="Backend"><node ID="103" TEXT="User&#x20;created&#x20;in&#x20;DB" ></node><node ID="104" TEXT="Password&#x20;hashed" ></node><node ID="105" TEXT="Duplicate&#x20;email&#x20;blocked" ></node><node ID="106" TEXT="Logs&#x20;show&#x20;expected&#x20;status&#x20;codes" ></node></node><node ID="107" TEXT="Database"><node ID="108" TEXT="users&#x20;row&#x20;present" ></node><node ID="109" TEXT="profile/onboarding&#x20;rows&#x20;(if&#x20;used)" /><node ID="110" TEXT="terms_accepted_at&#x20;updated&#x20;(if&#x20;gated)" ></node></node></node><node ID="123" TEXT="9)&#x20;Developer&#x20;Registration"><node ID="124" TEXT="Entry&#x20;Point"><node ID="125" TEXT="Developer&#x20;portal&#x20;link&#x20;or&#x20;/auth/register?role=developer" ></node><node ID="126" TEXT="Marketplace&#x20;&#x201C;Become&#x20;a&#x20;Developer&#x201D;&#x20;CTA" ></node></node><node ID="127" TEXT="Additional&#x20;Form&#x20;Fields"><node ID="128" TEXT="Organization&#x20;/&#x20;Company&#x20;name&#x20;(optional)" ></node><node ID="129" TEXT="Developer&#x20;use-case&#x20;/&#x20;intent&#x20;(dropdown)" ></node><node ID="130" TEXT="Accept&#x20;Developer&#x20;Terms&#x20;&amp;&#x20;API&#x20;Usage&#x20;Policy" ></node><node ID="131" TEXT="Website&#x20;/&#x20;GitHub&#x20;URL&#x20;(optional)" ></node></node><node ID="132" TEXT="Backend&#x20;Logic"><node ID="133" TEXT="Standard&#x20;user&#x20;creation&#x20;(steps&#x20;3&#x2013;4&#x20;above)" ></node><node ID="134" TEXT="Assign&#x20;role&#x20;=&#x20;&#x2018;developer&#x2019;"><node ID="135" TEXT="INSERT&#x20;user_roles&#x20;(user_id,&#x20;role)&#x20;VALUES&#x20;(:id,&#x20;&#x2018;developer&#x2019;)" ></node></node><node ID="136" TEXT="Provision&#x20;API&#x20;credentials"><node ID="137" TEXT="Generate&#x20;API&#x20;key&#x20;pair&#x20;(client_id&#x20;+&#x20;client_secret)" ></node><node ID="138" TEXT="Store&#x20;hashed&#x20;client_secret&#x20;in&#x20;api_credentials&#x20;table" ></node><node ID="139" TEXT="Return&#x20;client_secret&#x20;once&#x20;(show&#x20;in&#x20;UI,&#x20;never&#x20;again)" ></node></node><node ID="140" TEXT="Record&#x20;developer_terms_accepted_at&#x20;+&#x20;version" ></node></node><node ID="141" TEXT="Post-Register&#x20;Routing"><node ID="142" TEXT="/onboarding/developer-setup" ></node><node ID="143" TEXT="/developer/dashboard&#x20;(API&#x20;keys,&#x20;docs,&#x20;sandbox)" ></node><node ID="144" TEXT="/developer/apps&#x20;(manage&#x20;registered&#x20;applications)" ></node></node><node ID="145" TEXT="Verification"><node ID="146" TEXT="Role&#x20;=&#x20;developer&#x20;in&#x20;user_roles&#x20;table" ></node><node ID="147" TEXT="API&#x20;credentials&#x20;row&#x20;created" ></node><node ID="148" TEXT="Developer&#x20;terms&#x20;acceptance&#x20;recorded" ></node><node ID="149" TEXT="Developer&#x20;dashboard&#x20;accessible&#x20;after&#x20;login" ></node></node></node><node ID="150" TEXT="10)&#x20;Admin&#x20;Registration"><node ID="151" TEXT="Entry&#x20;Point"><node ID="152" TEXT="Invite-only:&#x20;existing&#x20;Admin&#x20;sends&#x20;invite&#x20;link" ></node><node ID="153" TEXT="POST&#x20;/api/admin/invite&#x20;&#x2192;&#x20;generates&#x20;signed&#x20;invite&#x20;token" ></node><node ID="154" TEXT="Invite&#x20;email&#x20;sent&#x20;with&#x20;one-time&#x20;registration&#x20;URL" ></node><node ID="155" TEXT="No&#x20;public&#x20;self-registration&#x20;for&#x20;Admin&#x20;role" ></node></node><node ID="156" TEXT="Invite&#x20;Token&#x20;Handling"><node ID="157" TEXT="Token&#x20;stored&#x20;hashed&#x20;in&#x20;admin_invites&#x20;table" ></node><node ID="158" TEXT="Expiry&#x20;(e.g.&#x20;48h),&#x20;single-use,&#x20;revocable" ></node><node ID="159" TEXT="Validate&#x20;token&#x20;before&#x20;showing&#x20;register&#x20;form" ></node><node ID="160" TEXT="Expired/invalid&#x20;token&#x20;&#x2192;&#x20;403&#x20;+&#x20;friendly&#x20;message" ></node></node><node ID="161" TEXT="Register&#x20;Form"><node ID="162" TEXT="Same&#x20;base&#x20;fields&#x20;as&#x20;standard&#x20;registration&#x20;(name,&#x20;email,&#x20;password)" ></node><node ID="163" TEXT="Email&#x20;pre-filled&#x20;from&#x20;invite&#x20;(read-only)" ></node><node ID="164" TEXT="MFA&#x20;setup&#x20;required&#x20;at&#x20;registration" ></node></node><node ID="165" TEXT="Backend&#x20;Logic"><node ID="166" TEXT="Validate&#x20;invite&#x20;token&#x20;(exists,&#x20;not&#x20;expired,&#x20;not&#x20;used)" ></node><node ID="167" TEXT="Standard&#x20;user&#x20;creation&#x20;(steps&#x20;3&#x2013;4&#x20;above)" ></node><node ID="168" TEXT="Assign&#x20;role&#x20;=&#x20;&#x2018;admin&#x2019;"><node ID="169" TEXT="INSERT&#x20;user_roles&#x20;(user_id,&#x20;role)&#x20;VALUES&#x20;(:id,&#x20;&#x2018;admin&#x2019;)" ></node></node><node ID="170" TEXT="Mark&#x20;invite&#x20;token&#x20;as&#x20;consumed"><node ID="171" TEXT="UPDATE&#x20;admin_invites&#x20;SET&#x20;used_at=now(),&#x20;used_by=:user_id" ></node></node><node ID="172" TEXT="Enforce&#x20;MFA&#x20;enrollment"><node ID="173" TEXT="Generate&#x20;TOTP&#x20;secret,&#x20;store&#x20;encrypted" ></node><node ID="174" TEXT="Require&#x20;MFA&#x20;confirmation&#x20;before&#x20;account&#x20;activation" ></node></node><node ID="175" TEXT="Audit&#x20;log:&#x20;admin_created&#x20;event&#x20;with&#x20;inviter&#x20;+&#x20;invitee" ></node></node><node ID="176" TEXT="Post-Register&#x20;Routing"><node ID="177" TEXT="/admin/mfa-setup&#x20;(complete&#x20;MFA&#x20;enrollment)" ></node><node ID="178" TEXT="/admin/dashboard&#x20;(user&#x20;management,&#x20;system&#x20;config)" ></node><node ID="179" TEXT="/admin/audit-log&#x20;(review&#x20;system&#x20;activity)" ></node></node><node ID="180" TEXT="Security&#x20;Controls"><node ID="181" TEXT="Only&#x20;existing&#x20;admins&#x20;can&#x20;create&#x20;invites" ></node><node ID="182" TEXT="MFA&#x20;mandatory&#x20;for&#x20;admin&#x20;accounts" ></node><node ID="183" TEXT="Admin&#x20;actions&#x20;logged&#x20;to&#x20;audit&#x20;trail" ></node><node ID="184" TEXT="Session&#x20;timeout&#x20;shorter&#x20;than&#x20;standard&#x20;users" ></node><node ID="185" TEXT="IP&#x20;allowlist&#x20;(optional,&#x20;configurable)" ></node></node><node ID="186" TEXT="Verification"><node ID="187" TEXT="Role&#x20;=&#x20;admin&#x20;in&#x20;user_roles&#x20;table" ></node><node ID="188" TEXT="Invite&#x20;token&#x20;marked&#x20;used" ></node><node ID="189" TEXT="MFA&#x20;enrolled&#x20;and&#x20;confirmed" ></node><node ID="190" TEXT="Audit&#x20;log&#x20;entry&#x20;for&#x20;admin&#x20;creation" ></node><node ID="191" TEXT="Admin&#x20;dashboard&#x20;accessible&#x20;after&#x20;MFA&#x20;verification" ></node></node></node></node></map>