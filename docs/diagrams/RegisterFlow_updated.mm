<map version="0.7.1"><node ID="1" TEXT="CapeControl&#x20;Registration&#x20;Flow&#x20;&amp;&#x20;Database&#x20;Interaction"><node ID="2" TEXT="1)&#x20;Entry&#x20;Point"><node ID="3" TEXT="Landing&#x20;Page"><node ID="4" TEXT="User&#x20;clicks&#x20;Create&#x20;free&#x20;account&#x20;(global&#x20;CTA)" ></node><node ID="5" TEXT="Route&#x20;to&#x20;/auth/register" /><node ID="6" TEXT="Preserve&#x20;context&#x20;(optional)"><node ID="7" TEXT="ref/utm/interest&#x20;trail&#x20;stored&#x20;safely" /></node></node></node><node ID="8" TEXT="2)&#x20;Register&#x20;Form&#x20;(Frontend)"><node ID="9" TEXT="User&#x20;inputs"><node ID="10" TEXT="Name&#x20;(optional/required&#x20;per&#x20;spec)" /><node ID="11" TEXT="Email" ></node><node ID="12" TEXT="Password" ></node><node ID="13" TEXT="Confirm&#x20;password" ></node><node ID="14" TEXT="Accept&#x20;Terms/Privacy&#x20;checkbox&#x20;(optional:&#x20;gate&#x20;at&#x20;/terms)" /></node><node ID="15" TEXT="Client-side&#x20;validation"><node ID="16" TEXT="Email&#x20;format" ></node><node ID="17" TEXT="Password&#x20;rules&#x20;(length/complexity)" /><node ID="18" TEXT="Password&#x20;match" ></node><node ID="19" TEXT="Terms&#x20;checkbox&#x20;required?" ></node></node><node ID="20" TEXT="If&#x20;validation&#x20;fails"><node ID="21" TEXT="Show&#x20;inline&#x20;errors" ></node><node ID="22" TEXT="Do&#x20;not&#x20;submit" ></node></node><node ID="23" TEXT="Submit&#x20;UX"><node ID="24" TEXT="Disable&#x20;button&#x20;+&#x20;show&#x20;loading" ></node><node ID="25" TEXT="Prevent&#x20;double-submit" ></node></node></node><node ID="26" TEXT="3)&#x20;API&#x20;Call&#x20;to&#x20;Backend"><node ID="27" TEXT="Request"><node ID="28" TEXT="POST&#x20;/api/auth/register&#x20;(example)" /><node ID="29" TEXT="Payload"><node ID="30" TEXT="name,email,password,(confirm_password&#x20;for&#x20;validation&#x20;only),termsAccepted(optional)" ></node></node></node><node ID="31" TEXT="Response&#x20;handling"><node ID="32" TEXT="Success&#x20;-&#x20;advance&#x20;flow" ></node><node ID="33" TEXT="Failure&#x20;-&#x20;friendly&#x20;message" ></node></node></node><node ID="34" TEXT="4)&#x20;Backend&#x20;Registration&#x20;Logic"><node ID="35" TEXT="Input&#x20;processing"><node ID="36" TEXT="Trim&#x20;fields" ></node><node ID="37" TEXT="Normalize&#x20;email&#x20;(lowercase)" ></node><node ID="38" TEXT="Validate&#x20;schema&#x20;(required&#x20;fields,&#x20;password&#x20;policy)" ></node><node ID="118" TEXT="confirm_password&#x20;used&#x20;only&#x20;to&#x20;validate&#x20;match;&#x20;discard" ></node></node><node ID="39" TEXT="Security"><node ID="40" TEXT="Rate-limit&#x20;registration&#x20;attempts" ></node><node ID="41" TEXT="Audit&#x20;log&#x20;(optional)" ></node><node ID="42" TEXT="Never&#x20;store&#x20;plain&#x20;password" ></node></node><node ID="43" TEXT="Database&#x20;interaction"><node ID="115" TEXT="BEGIN&#x20;transaction&#x20;(users&#x20;+&#x20;related&#x20;rows)" ></node><node ID="44" TEXT="Enforce&#x20;unique&#x20;email&#x20;(race-safe)"><node ID="45" TEXT="DB&#x20;UNIQUE&#x20;constraint:&#x20;CITEXT&#x20;email&#x20;or&#x20;UNIQUE(lower(email))" ></node><node ID="112" TEXT="Optional&#x20;fast-path:&#x20;SELECT&#x20;by&#x20;email&#x20;for&#x20;friendly&#x20;message&#x20;(not&#x20;authoritative)" ></node><node ID="113" TEXT="Still&#x20;rely&#x20;on&#x20;UNIQUE&#x20;constraint&#x20;as&#x20;final&#x20;authority" ></node></node><node ID="46" TEXT="Hash&#x20;password"><node ID="47" TEXT="bcrypt/argon2&#x20;hash" /></node><node ID="48" TEXT="Insert&#x20;user"><node ID="49" TEXT="INSERT&#x20;into&#x20;users&#x20;(...)&#x20;RETURNING&#x20;id&#x20;(handle&#x20;unique_violation&#x20;-&gt;&#x20;409)" ></node><node ID="114" TEXT="On&#x20;unique_violation:&#x20;return&#x20;409&#x20;(avoid&#x20;user&#x20;enumeration)" ></node></node><node ID="50" TEXT="Create&#x20;related&#x20;rows&#x20;(optional)"><node ID="51" TEXT="profile&#x20;row" ></node><node ID="52" TEXT="onboarding_state&#x20;row" ></node><node ID="53" TEXT="terms_acceptance&#x20;state&#x20;fields" ></node></node><node ID="116" TEXT="COMMIT&#x20;transaction&#x20;(ROLLBACK&#x20;on&#x20;any&#x20;error)"><node ID="117" TEXT="Rollback&#x20;prevents&#x20;partial&#x20;user/profile/onboarding&#x20;rows" /></node></node><node ID="54" TEXT="Outcomes"><node ID="55" TEXT="201&#x20;Created"><node ID="56" TEXT="Return&#x20;user&#x20;id&#x20;+&#x20;session/token&#x20;(if&#x20;auto-login)" /></node><node ID="57" TEXT="409&#x20;Conflict"><node ID="58" TEXT="Email&#x20;already&#x20;exists" ></node></node><node ID="59" TEXT="400&#x20;Bad&#x20;Request"><node ID="60" TEXT="Validation&#x20;error&#x20;details" ></node></node><node ID="61" TEXT="429&#x20;Too&#x20;Many&#x20;Requests"><node ID="62" TEXT="Rate-limited" ></node></node><node ID="63" TEXT="500&#x20;Server&#x20;Error"><node ID="64" TEXT="Generic&#x20;message&#x20;to&#x20;user" ></node></node></node></node><node ID="65" TEXT="5)&#x20;Auth&#x20;Session&#x20;Creation"><node ID="66" TEXT="Option&#x20;A:&#x20;Auto-login"><node ID="67" TEXT="Issue&#x20;JWT/session" /><node ID="68" TEXT="Store&#x20;securely"><node ID="69" TEXT="Prefer&#x20;httpOnly&#x20;cookie" ></node></node></node><node ID="70" TEXT="Option&#x20;B:&#x20;Email&#x20;verification"><node ID="71" TEXT="Create&#x20;unverified&#x20;account"><node ID="119" TEXT="Generate&#x20;verification&#x20;token&#x20;(random,&#x20;one-time)" ></node><node ID="120" TEXT="Store&#x20;hashed&#x20;token&#x20;+&#x20;expiry&#x20;in&#x20;DB&#x20;(verification_tokens)" ></node><node ID="121" TEXT="Send&#x20;email&#x20;only&#x20;after&#x20;successful&#x20;commit" ></node></node><node ID="72" TEXT="Send&#x20;verification&#x20;email" ></node><node ID="73" TEXT="Block&#x20;login&#x20;until&#x20;verified&#x20;(optional)" ></node></node></node><node ID="74" TEXT="6)&#x20;Post-Register&#x20;Routing"><node ID="75" TEXT="Recommended&#x20;MVP&#x20;path"><node ID="76" TEXT="/onboarding/welcome" /><node ID="77" TEXT="/onboarding/profile" /><node ID="78" TEXT="/onboarding/checklist" /><node ID="79" TEXT="/app/dashboard" /></node><node ID="80" TEXT="Preserve&#x20;context"><node ID="81" TEXT="Show&#x20;personalized&#x20;next-step&#x20;based&#x20;on&#x20;ref/interest" /></node></node><node ID="82" TEXT="7)&#x20;Terms&#x20;Gate&#x20;(if&#x20;enforced)"><node ID="83" TEXT="Data&#x20;fields"><node ID="84" TEXT="terms_accepted_at&#x20;timestamp&#x20;(or&#x20;equivalent)" ></node><node ID="122" TEXT="terms_version&#x20;(string)" ></node></node><node ID="85" TEXT="Frontend&#x20;guard"><node ID="86" TEXT="If&#x20;missing,&#x20;force&#x20;route&#x20;to&#x20;/terms" /><node ID="87" TEXT="Block&#x20;/app/*&#x20;until&#x20;accepted" /></node><node ID="88" TEXT="Backend&#x20;enforcement"><node ID="89" TEXT="Protected&#x20;endpoints&#x20;verify&#x20;terms&#x20;state" ></node></node><node ID="90" TEXT="Acceptance"><node ID="91" TEXT="User&#x20;accepts&#x20;terms" ></node><node ID="92" TEXT="Update&#x20;DB"><node ID="93" TEXT="UPDATE&#x20;users&#x20;SET&#x20;terms_accepted_at=now(),&#x20;terms_version=:current" ></node></node><node ID="94" TEXT="Allow&#x20;app&#x20;access" ></node></node></node><node ID="95" TEXT="8)&#x20;Verification&#x20;Checklist&#x20;(Evidence)"><node ID="96" TEXT="Frontend"><node ID="97" TEXT="Routes:&#x20;landing&#x20;→&#x20;register&#x20;→&#x20;next" ></node><node ID="98" TEXT="Validation&#x20;errors&#x20;render&#x20;correctly" ></node><node ID="99" TEXT="Loading&#x20;state&#x20;works" ></node><node ID="100" TEXT="409/400/429&#x20;messages&#x20;mapped&#x20;cleanly" /><node ID="101" TEXT="Auth&#x20;stored&#x20;securely" ></node></node><node ID="102" TEXT="Backend"><node ID="103" TEXT="User&#x20;created&#x20;in&#x20;DB" ></node><node ID="104" TEXT="Password&#x20;hashed" ></node><node ID="105" TEXT="Duplicate&#x20;email&#x20;blocked" ></node><node ID="106" TEXT="Logs&#x20;show&#x20;expected&#x20;status&#x20;codes" ></node></node><node ID="107" TEXT="Database"><node ID="108" TEXT="users&#x20;row&#x20;present" ></node><node ID="109" TEXT="profile/onboarding&#x20;rows&#x20;(if&#x20;used)" /><node ID="110" TEXT="terms_accepted_at&#x20;updated&#x20;(if&#x20;gated)" ></node></node></node></node></map>