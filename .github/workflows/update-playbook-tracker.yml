name: Update Playbooks Overview
on:
  push:
    paths:
      - "docs/playbooks/*.md"
      - "scripts/gen_playbooks_oververview.py"
      - ".github/workflows/update-playbook-tracker.yml"
  schedule:
    - cron: "20 5 * * *"   # daily 05:20 UTC

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          REF: ${{ github.ref_name }}
          SHA: ${{ github.sha }}
        run: |
          git clone --branch "$REF" --single-branch "https://x-access-token:${TOKEN}@github.com/${REPO}.git" repo
          cd repo
          git checkout -B "$REF" "$SHA"

      - name: Read current % from PLAYBOOKS_OVERVIEW.md (if present)
        id: before
        shell: bash
        working-directory: repo
        run: |
          if [[ -f docs/PLAYBOOKS_OVERVIEW.md ]]; then
            PCT=$(grep -oP 'Overall Progress:\s*\d+/\d+\s*\(\K\d+(?=%\))' docs/PLAYBOOKS_OVERVIEW.md || true)
          fi
          echo "pct=${PCT:-}" >> "$GITHUB_OUTPUT"

      - name: Generate overview
        working-directory: repo
        run: python3 scripts/gen_playbooks_oververview.py

      - name: Read new %
        id: after
        shell: bash
        working-directory: repo
        run: |
          PCT=$(grep -oP 'Overall Progress:\s*\d+/\d+\s*\(\K\d+(?=%\))' docs/PLAYBOOKS_OVERVIEW.md || echo "")
          echo "pct=$PCT" >> "$GITHUB_OUTPUT"

      - name: Update README badge if % changed
        if: steps.before.outputs.pct != steps.after.outputs.pct
        shell: bash
        working-directory: repo
        run: |
          NEW=${{ steps.after.outputs.pct }}
          [[ -z "$NEW" ]] && exit 0
          BADGE_RE='(https://img.shields.io/badge/Playbooks-)[0-9]+(%25_complete-.*)'
          if [[ -f README.md ]]; then
            sed -E -i "s#${BADGE_RE}#\1${NEW}\2#g" README.md
          fi

      - name: Commit changes if any
        shell: bash
        working-directory: repo
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          REF: ${{ github.ref_name }}
        run: |
          git config user.name "CodexBot"
          git config user.email "bot@cape-control.com"
          if ! git diff --quiet -- docs/PLAYBOOKS_OVERVIEW.md README.md; then
            git add docs/PLAYBOOKS_OVERVIEW.md README.md
            git commit -m "chore: update playbooks overview (progress ${{ steps.after.outputs.pct }}%)"
            git remote set-url origin "https://x-access-token:${TOKEN}@github.com/${REPO}.git"
            if ! git push; then
              echo "WARN: git push failed (likely permissions). Skipping to keep workflow green."
              exit 0
            fi
          else
            echo "No changes to commit."
          fi
