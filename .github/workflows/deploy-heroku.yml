name: Deploy to Heroku Production

on:
  push:
    branches: [main]
    paths:
      - "backend/**"
      - "client/**"
      - "app/**"
      - "requirements*.txt"
      - "Dockerfile*"
      - "heroku.yml"
      - "runtime.txt"
      - ".github/workflows/deploy-heroku.yml"
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment even if no changes'
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  id-token: write

concurrency:
  group: deploy-heroku-${{ github.ref }}
  cancel-in-progress: true

env:
  HEROKU_APP: autorisen-dac8e65796e7

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (no marketplace actions)
        run: |
          set -euo pipefail
          git init .
          git remote add origin "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git"
          git fetch --depth=1 origin "${GITHUB_SHA}"
          git checkout --detach "${GITHUB_SHA}"
          git submodule update --init --recursive || true

      - name: Plan snapshot validation
        run: |
          python3 scripts/plan_sync.py --check-only
          make project-info

      - name: Install Heroku CLI
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
        run: |
          curl https://cli-assets.heroku.com/install.sh | sh
          heroku --version
          # Non-interactive auth for later heroku commands
          cat > ~/.netrc <<EOF
          machine api.heroku.com
            login _
            password ${HEROKU_API_KEY}
          machine git.heroku.com
            login _
            password ${HEROKU_API_KEY}
          EOF

      - name: Docker login to Heroku registry
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
        run: |
          echo "$HEROKU_API_KEY" | docker login --username=_ --password-stdin registry.heroku.com

      - name: Verify project structure
        run: |
          echo "=== Project Structure Verification ==="
          ls -la
          echo "=== Backend Structure ==="
          find backend/ -name "*.py" | head -10 || echo "Backend files not found"
          echo "=== App Structure ==="
          find app/ -name "*.py" | head -5 || echo "App files not found"
          echo "=== Client Structure ==="
          ls -la client/ || echo "Client directory not found"
          echo "=== Client Assets ==="
          ls -la client/public/ || echo "Client public directory not found"
          find client/public/ -name "*.png" -o -name "*.ico" | head -5 || echo "Assets not found"
          echo "=== Requirements Files ==="
          ls -la requirements*.txt

      - name: Build production image
        run: |
          IMAGE="registry.heroku.com/${HEROKU_APP}/web"
          echo "ğŸ³ Building production image: $IMAGE"
          
          # Build with production optimizations and multi-stage
          docker build \
            --tag "$IMAGE" \
            --file Dockerfile \
            --build-arg NODE_ENV=production \
            --build-arg ENV=prod \
            --progress=plain \
            .
          
      - name: Verify built image
        run: |
          IMAGE="registry.heroku.com/${HEROKU_APP}/web"
          echo "=== Container Structure Verification ==="
          docker run --rm "$IMAGE" sh -c "ls -la /app/"
          echo "=== Frontend Assets Verification ==="
          docker run --rm "$IMAGE" sh -c "find /app/client/dist/ -name '*.html' -o -name '*.js' -o -name '*.css' | head -10" || echo "Frontend assets not found"
          echo "=== Backend Modules Verification ==="
          docker run --rm "$IMAGE" sh -c "find /app/backend/ -name '*.py' | head -10" || echo "Backend modules not found"

      - name: Push image to Heroku registry
        run: |
          IMAGE="registry.heroku.com/${HEROKU_APP}/web"
          echo "ğŸ“¤ Pushing image to Heroku registry..."
          docker push "$IMAGE"

      - name: Release container to production
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
        run: |
          echo "ğŸš€ Releasing container to production..."
          heroku container:release web -a "$HEROKU_APP"

      - name: Run database migrations
        if: always()
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
        run: |
          echo "ğŸ—ƒï¸ Running database migrations..."
          heroku run -a "$HEROKU_APP" -- \
            python -m alembic -c backend/alembic.ini upgrade head || echo "âš ï¸ Migration failed or not needed"

      - name: Verify deployment health
        run: |
          echo "ğŸ” Checking deployment health..."
          sleep 30  # Allow time for deployment
          
          APP_URL="https://${HEROKU_APP}.herokuapp.com"
          
          # Health check with retries
          for i in {1..5}; do
            if curl -f -sS "${APP_URL}/api/health"; then
              echo "âœ… Health check passed on attempt $i"
              break
            else
              echo "âš ï¸ Health check failed on attempt $i, retrying..."
              sleep 10
            fi
          done
          
          # CSRF endpoint check
          curl -f -sS -I "${APP_URL}/api/auth/csrf" || {
            echo "âš ï¸ CSRF endpoint check failed"
          }
          
          # Version check
          curl -f -sS "${APP_URL}/api/version" || {
            echo "âš ï¸ Version endpoint check failed"
          }
          
          echo "âœ… Deployment verification completed!"

      - name: Post-deployment summary
        if: always()
        run: |
          echo "=== Deployment Summary ==="
          echo "App: https://${HEROKU_APP}.herokuapp.com"
          echo "Health: https://${HEROKU_APP}.herokuapp.com/api/health"
          echo "Login: https://${HEROKU_APP}.herokuapp.com/auth/login"
          echo "Deployment completed at: $(date -u)"
