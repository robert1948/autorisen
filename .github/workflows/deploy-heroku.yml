name: Deploy to Heroku Production

on:
  push:
    branches: [main]
    paths:
      - "backend/**"
      - "client/**"
      - "infra/**"
      - "requirements*.txt"
      - "Dockerfile*"
      - "heroku.yml"
      - ".github/workflows/deploy-heroku.yml"
  workflow_dispatch: {}

permissions:
  contents: read
  id-token: write

concurrency:
  group: deploy-heroku-${{ github.ref }}
  cancel-in-progress: true

env:
  HEROKU_APP: ${{ secrets.HEROKU_APP }} # configure repo/org secret HEROKU_APP
  HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (no marketplace actions)
        run: |
          set -euo pipefail
          git init .
          git remote add origin "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git"
          git fetch --depth=1 origin "${GITHUB_SHA}"
          git checkout --detach "${GITHUB_SHA}"
          git submodule update --init --recursive || true

      - name: Install Heroku CLI
        run: |
          curl https://cli-assets.heroku.com/install.sh | sh
          heroku --version
          # Non-interactive auth for later heroku commands
          cat > ~/.netrc <<EOF
          machine api.heroku.com
            login _
            password ${HEROKU_API_KEY}
          machine git.heroku.com
            login _
            password ${HEROKU_API_KEY}
          EOF

      - name: Docker login to Heroku registry
        run: |
          echo "$HEROKU_API_KEY" | docker login --username=_ --password-stdin registry.heroku.com

      - name: Verify project structure
        run: |
          echo "=== Project Structure Verification ==="
          ls -la
          echo "=== Backend Structure ==="
          find backend/ -name "*.py" | head -10 || echo "Backend files not found"
          echo "=== Client Structure ==="
          ls -la client/ || echo "Client directory not found"
          echo "=== Client Assets ==="
          ls -la client/public/ || echo "Client public directory not found"
          find client/public/ -name "*.png" -o -name "*.ico" | head -5 || echo "Assets not found"

      - name: Build production image
        run: |
          IMAGE="registry.heroku.com/${HEROKU_APP}/web"
          echo "Building image: $IMAGE"
          
          # Build with production optimizations
          docker build \
            --tag "$IMAGE" \
            --file Dockerfile \
            --build-arg NODE_ENV=production \
            --build-arg ENV=prod \
            .
          
      - name: Verify built image
        run: |
          IMAGE="registry.heroku.com/${HEROKU_APP}/web"
          echo "=== Container Structure Verification ==="
          docker run --rm "$IMAGE" sh -c "ls -la /app/"
          echo "=== Frontend Assets Verification ==="
          docker run --rm "$IMAGE" sh -c "find /app/client/dist/ -name '*.html' -o -name '*.js' -o -name '*.css' | head -10" || echo "Frontend assets not found"
          echo "=== Backend Modules Verification ==="
          docker run --rm "$IMAGE" sh -c "find /app/backend/ -name '*.py' | head -10" || echo "Backend modules not found"

      - name: Push image to Heroku registry
        run: |
          IMAGE="registry.heroku.com/${HEROKU_APP}/web"
          docker push "$IMAGE"

      - name: Release container to production
        run: |
          heroku container:release web -a "$HEROKU_APP"

      - name: Run database migrations
        if: always()
        run: |
          echo "=== Database Migration ==="
          heroku run -a "$HEROKU_APP" -- \
            python -m alembic -c backend/alembic.ini upgrade head

      - name: Verify deployment health
        run: |
          echo "=== Deployment Health Check ==="
          sleep 30  # Allow time for deployment
          
          # Health check
          curl -f -sS "https://${HEROKU_APP}.herokuapp.com/api/health" || {
            echo "Health check failed"
            exit 1
          }
          
          # CSRF endpoint check
          curl -f -sS -I "https://${HEROKU_APP}.herokuapp.com/api/auth/csrf" || {
            echo "CSRF endpoint check failed"
            exit 1
          }
          
          echo "âœ… Deployment verified successfully!"

      - name: Post-deployment summary
        if: always()
        run: |
          echo "=== Deployment Summary ==="
          echo "App: https://${HEROKU_APP}.herokuapp.com"
          echo "Health: https://${HEROKU_APP}.herokuapp.com/api/health"
          echo "Login: https://${HEROKU_APP}.herokuapp.com/auth/login"
          echo "Deployment completed at: $(date -u)"
