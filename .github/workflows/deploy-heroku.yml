name: Deploy to Heroku (autorisen)

on:
  push:
    branches: [main]
    paths:
      - "backend/**"
      - "client/**"
      - "infra/**"
      - ".github/workflows/deploy-heroku.yml"
  workflow_dispatch: {}

permissions:
  contents: read
  id-token: write

concurrency:
  group: deploy-heroku-${{ github.ref }}
  cancel-in-progress: true

env:
  HEROKU_APP: ${{ secrets.HEROKU_APP }} # configure repo/org secret HEROKU_APP
  HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (no marketplace actions)
        run: |
          set -euo pipefail
          git init .
          git remote add origin "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git"
          git fetch --depth=1 origin "${GITHUB_SHA}"
          git checkout --detach "${GITHUB_SHA}"
          git submodule update --init --recursive || true

      - name: Install Heroku CLI
        run: |
          curl https://cli-assets.heroku.com/install.sh | sh
          heroku --version
          # Non-interactive auth for later heroku commands
          cat > ~/.netrc <<EOF
          machine api.heroku.com
            login _
            password ${HEROKU_API_KEY}
          machine git.heroku.com
            login _
            password ${HEROKU_API_KEY}
          EOF

      - name: Docker login to Heroku registry
        run: |
          echo "$HEROKU_API_KEY" | docker login --username=_ --password-stdin registry.heroku.com

      - name: (Optional) Enable Buildx if available
        run: |
          docker buildx version || true
          docker buildx create --use || true

      - name: Build image
        run: |
          IMAGE="registry.heroku.com/${HEROKU_APP}/web"
          docker build -t "$IMAGE" .

      - name: Push image
        run: |
          IMAGE="registry.heroku.com/${HEROKU_APP}/web"
          docker push "$IMAGE"

      - name: Release container
        run: |
          heroku container:release web -a "$HEROKU_APP"

      # OPTIONAL: run DB migrations (adjust or remove)
      - name: Run Alembic migrations
        if: always()
        run: |
          heroku run -a "$HEROKU_APP" -- \
            python -m alembic -c backend/alembic.ini upgrade head
