name: Deploy to Heroku (autorisen)

on:
  push:
    branches: [main]
    paths:
      - "backend/**"
      - "client/**"
      - "infra/**"
      - ".github/workflows/deploy-heroku.yml"
  workflow_dispatch: {}

permissions:
  contents: read
  id-token: write # keep if you later use OIDC; harmless otherwise

concurrency:
  group: deploy-heroku-${{ github.ref }}
  cancel-in-progress: true

env:
  HEROKU_APP: ${{ secrets.HEROKU_APP_NAME }} # e.g. autorisen
  HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Heroku Container Registry
        run: |
          echo "$HEROKU_API_KEY" | docker login --username=_ --password-stdin registry.heroku.com

      - name: Install Heroku CLI
        run: |
          curl https://cli-assets.heroku.com/install.sh | sh
          heroku --version
          # ensure CLI uses the provided key (no interactive login)
          cat > ~/.netrc <<EOF
          machine api.heroku.com
            login _
            password ${HEROKU_API_KEY}
          machine git.heroku.com
            login _
            password ${HEROKU_API_KEY}
          EOF

      - name: Build image
        run: |
          IMAGE="registry.heroku.com/${HEROKU_APP}/web"
          docker build -t "$IMAGE" .

      - name: Push image
        run: |
          IMAGE="registry.heroku.com/${HEROKU_APP}/web"
          docker push "$IMAGE"

      - name: Release container
        run: |
          heroku container:release web -a "$HEROKU_APP"

      # OPTIONAL: run DB migrations (adjust or remove)
      - name: Run Alembic migrations
        if: always()
        run: |
          heroku run -a "$HEROKU_APP" -- \
            python -m alembic -c backend/alembic.ini upgrade head
