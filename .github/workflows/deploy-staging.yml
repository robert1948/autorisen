name: Deploy to Staging

on:
  push:
    branches: [ develop, staging ]
    paths:
      - "backend/**"
      - "client/**" 
      - "requirements*.txt"
      - "Dockerfile*"
      - ".github/workflows/deploy-staging.yml"
  workflow_dispatch: {}

permissions:
  contents: read
  id-token: write

concurrency:
  group: deploy-staging-${{ github.ref }}
  cancel-in-progress: true

env:
  STAGING_APP: autorisen
  STAGING_BASE_URL: https://dev.cape-control.com

jobs:
  test-before-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-python@v5
        with: 
          python-version: "3.12"
          
      - name: Install tooling
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt pytest

      - name: Run codex test suite
        env:
          ENV: test
          DATABASE_URL: sqlite:////tmp/staging_test.db
          DISABLE_RECAPTCHA: "true"
          RUN_DB_MIGRATIONS_ON_STARTUP: "0"
        run: |
          make codex-test

  deploy:
    runs-on: ubuntu-latest
    needs: test-before-deploy
    if: ${{ github.repository_owner != 'dependabot' }}
    steps:
      - uses: actions/checkout@v4

      - name: Plan snapshot validation
        run: |
          python3 scripts/plan_sync.py --check-only
          make project-info

      - name: Set up Heroku CLI
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
        run: |
          curl https://cli-assets.heroku.com/install.sh | sh
          heroku --version
          echo "$HEROKU_API_KEY" | docker login --username=_ --password-stdin registry.heroku.com

      - name: Build staging image
        run: |
          IMAGE="registry.heroku.com/${STAGING_APP}/web"
          docker build -t "$IMAGE" \
            --build-arg NODE_ENV=staging \
            --build-arg ENV=staging \
            .

      - name: Push to Heroku registry
        run: |
          IMAGE="registry.heroku.com/${STAGING_APP}/web"
          docker push "$IMAGE"

      - name: Release to staging
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
        run: |
          heroku container:release web -a "$STAGING_APP"

      - name: Run database migrations
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
        run: |
          heroku run -a "$STAGING_APP" -- \
            python -m alembic -c backend/alembic.ini upgrade head

      - name: Staging smoke test
        run: |
          # Wait for deployment to be ready
          sleep 30
          
          # Health check
          BASE_URL="${STAGING_BASE_URL:-https://${STAGING_APP}.herokuapp.com}"
          curl -f -sS "${BASE_URL}/api/health" | jq .
          
          # CSRF endpoint
          curl -f -sS -I "${BASE_URL}/api/auth/csrf"
          
          echo "âœ… Staging deployment verified!"

      - name: Deployment summary
        run: |
          BASE_URL="${STAGING_BASE_URL:-https://${STAGING_APP}.herokuapp.com}"
          echo "ðŸš€ Staging deployment complete!"
          echo "App URL: ${BASE_URL}"
          echo "Health: ${BASE_URL}/api/health"
