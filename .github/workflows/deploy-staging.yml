name: Deploy to Heroku (staging)

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: deploy-staging
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.repository_owner == 'robert1948'
    env:
      HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
      APP: ${{ secrets.HEROKU_APP_STAGING }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify required files exist
        run: |
          set -euo pipefail
          test -f Procfile
          test -f requirements.txt
          test -f runtime.txt

      - name: Install Heroku CLI
        run: |
          curl -fsSL https://cli-assets.heroku.com/install-ubuntu.sh | sh
          heroku --version

      - name: Set Heroku remote (HTTPS w/ API key)
        run: |
          git remote add heroku "https://heroku:${HEROKU_API_KEY}@git.heroku.com/${APP}.git" || \
          git remote set-url heroku "https://heroku:${HEROKU_API_KEY}@git.heroku.com/${APP}.git"

      - name: Ensure Python buildpack (idempotent)
        run: |
          heroku buildpacks:clear -a "${APP}" || true
          heroku buildpacks:add heroku/python -a "${APP}" || true

      - name: Push -> build -> release
        run: |
          git push heroku HEAD:main -f

      - name: Make sure web dyno is up
        run: |
          heroku ps:scale web=1 -a "${APP}" || true
          heroku ps -a "${APP}"

      - name: Wait for dyno to boot
        run: |
          # Best-effort: wait for dyno state or show recent releases
          heroku ps:wait -a "${APP}" || true
          heroku releases -a "${APP}" | head -n 5 || true

      - name: Health check
        run: |
          set -euo pipefail
          URL=$(heroku info -a "${APP}" | sed -n 's/^Web URL: *//p')
          BASE=${URL%/}
          echo "Probing ${BASE}..."
          for i in $(seq 1 24); do
            if curl -fsS "${BASE}/api/health" \
              || curl -fsS "${BASE}/health" \
              || curl -fsS "${BASE}/"; then
              echo "✅ Healthy"
              exit 0
            fi
            echo "⏳ Not ready yet ($i/24); sleeping 5s..."
            sleep 5
          done
          echo "❌ Health check failed. Recent logs:" >&2
          heroku logs -n 200 -a "${APP}" || true
          exit 1

      - name: Show app URL
        run: |
          heroku info -a "${APP}" | sed -n 's/^Web URL: *//p'
